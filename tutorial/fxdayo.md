# よろずDXRとよろずFX

まさかこのチュートリアルを読む人が現れるとは、いいでしょう。

わりと獣道であり、バージョンごとに仕様の変化に振り回される事もあるでしょうがそういう運命を自ら選んだのだと諦めてがんばってください。

## ダヨに金棒

まず、MikuMikuDayoがどうやってDirectX12の上でエフェクトを作って遊べるようになっているのかという話からします。

MikuMikuDayoを作るために、いくつもフレームワークを自作しました。エフェクトと関係があるのはDirectX12ラッパーである**よろずDXR**と、よろずDXRの上で動くエフェクトフレームワークである**よろずFX**です。

よろずDXRは以下のような役割を担います。

- D3D12DeviceやD3D12CommandList、スワップチェーンなどDirectX12関係のオブジェクトのカプセル化
- 入出力リソースとシェーダをカプセル化した**パス**オブジェクトの構築、起動
- 画像ファイルからテクスチャへの読み込み、テクスチャから画像ファイルへの保存などのユーティリティ

グラフィックスのレンダリングを思い浮かべた場合、GPUはテクスチャや頂点バッファなどを入力リソースとしてvetex shader、pixel shaderを起動し、画面表示用に用意されたテクスチャなどの出力リソースに書き込むことでレンダリングを実現します。

こうした入力リソースをシェーダに入力して、出力リソースに出力させる1回の動作を**パス**と呼びます。

## パスの分類
よろずDXRにおいてパスは、使用するシェーダの種類によって以下の4つに分類されます

1. raytracing shader群を使う、**raytracingパス**
2. vertex shader, pixel shaderを使う、**rasterizerパス**
3. rasterizerパスを簡略化した **postprocessパス**
4. compute shaderを使う **computeパス**

エフェクトの作成をする側から見ると、よろずDXRはパスを構成し、起動する事が主な仕事です。

パス1個だけではごく簡単な事しか出来ませんから、パスを幾つもまとめて実行できるようにし、どんなパスをどのような条件で起動するのかといった事を記述できるようにしてMikuMikuDayoから呼び出せるようにしたのが**よろずFX**です。

よろずFXはJsonnetというjsonの上位互換の書式を使ってエフェクトを構成するパスとリソースの定義を記述し、各パスから呼び出されるシェーダはHLSLで書くことが出来ます。

よろずFXでは更にファンクショナルパスといって、よろずDXRの機能をカプセル化してパスと同様に使えるようにしたものを提供します。通常のパスと異なる点はシェーダをユーザー側で用意しなくて良い点です。

1. サイズとフォーマットの等しいリソースのコピーを行う、**copy**パス
2. リソースを定数で埋める**clearRTV,clearUAV**パス
3. mipmapテクスチャの最上位のmipレベルの内容から下位のmipレベルの内容を生成する**mipmapgen**パス


## エフェクトの分類

よろずFXで作れるエフェクトは、以下の3種類に分類できます

1. スキニングなど物体の変形を行うデフォーマ(**deform**)
2. デフォーマが変形させたvertex bufferなどを元に画面の描画などを行うレンダラ(**render**)
3. レンダラが出力した画像を元に絵を仕上げていくポストプロセス(**postprocess**)

1フレームの描画が開始すると各モデルに割り当てられたデフォーマが実行され、全てのモデルについてのデフォーマの処理が完了するとレンダラが起動して描画結果がテクスチャに格納されます。その結果をもとにポストプロセス群が実行され、全てのポストプロセスが完了して(ほぼ)最終的な描画結果が出来上がると画面に出力されるという流れになっています。

エフェクトは0個以上のパスの集合として定義されます。何もしないけどリソースを定義するだけのパスが0個のエフェクトというのも考えられますが、基本的には1つ以上のパスでしょう。例えば画面をモノクロにするポストプロセスだったら、処理中の画面の内容をテクスチャから読み取って、白黒に変換して、デフォルト出力先に出力する1パスのエフェクトになるでしょう。

## エフェクトの記述

エフェクトを起動するためのエフェクトファイルの拡張子は`.fxdayo`であり、UTF-8エンコードで記述されたテキストファイルです。


## エフェクトの起動

デフォーマとポストプロセスはエフェクトファイルと同一ディレクトリに存在する同名のモデル(PMXファイル)がMikuMikuDayoに読み込まれると起動します。

レンダラについては`MikuMikuDayo/renderer/`フォルダにある`.fxdayo`ファイルがMikuMikuDayo起動時に検索され、MikuMikuDayoの`Renderer`メニューから選択・起動できるようになります。


## まとめ

- パスとは入力リソースをシェーダで処理して出力リソースに出力する1回の動作であり、使いたいシェーダに応じて種類がある
- エフェクトは複数のパスと複数のリソースの定義で出来ており、用途によってデフォーマ・レンダラ・ポストプロセスという3種類に分かれる
- エフェクトのソースコードは拡張子`.fxdayo`でUTF-8で記述する

今はとりあえずこれだけおさえておけば大丈夫です。

次の章から具体的なコードのサンプルを見ながら、エフェクトを作っていきます。
