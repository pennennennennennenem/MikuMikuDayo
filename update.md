# 更新履歴

## β4→version 1.00

### MikuMikuDayo.exe
- 外部親設定ダイアログ作り替え。1体のモデルの複数のボーンに外部親を設定できるようにした
- 上書き保存時に確認、上書保存時に.bakファイル作成の設定を追加
- dayoファイルに作業時間を保存し、ファイルより作業時間が短い場合は上書き保存時に特に警告を出すようにした
- postprocessの起動順にはpostprocessの付いたモデルだけ色分け表示するようにして視認性を改善した
- カメラのリアルタイム記録で、既存のキーの打ってある範囲を超えた記録期間がある場合に既存のカメラキーが正しく消去されず追記されてしまうバグを修正
- 遠い所に小数の頂点のみ持っているコントローラ用のモデルなど…BLASの妨げになるけどなんとかしたい→とりあえず全頂点の原点からの距離が1E+5以上ならdrawable = falseとした
- Materialsウィンドウ、set recommendsボタンの効果範囲を選択中のマテリアルに限定した
- 物理ボーンが選択されていない時はphysicsチェックボックスを非アクティブにした
- 編集中モデルの物理の更新を直感的にした
- Snapの設定をBoneウィンドウからconfigに移した
- 「モデルのキー編集時もカメラのキーを合わせて表示する」項目がconfig.jsonではなくdayoファイル側に保存されていたのを修正
- 物理演算をconfig.dayoの内容に従って、ジョイントを選択してBullet2.75に近い雰囲気の挙動に出来るようにした
- screen.bmpをMatDescから扱えるようにした
- 追加UV1～4をシェーダ内で扱えるようにした
- printscreenキーを押したときにscreenshotsフォルダにスクショを撮る機能をon/offできるようにした
- デフォーマで定義されているリソースを、そのデフォーマに処理されているモデルに割り当てられたMatDescから読めるようにした
- PMXの材質から参照されているテクスチャが存在しない場合、ダミーテクスチャを割り当てるのではなく、材質のtex,spTexを-1に書き換えるようにした

### よろずDXR,よろずFX
- controllersオブジェクトにslider,descパラメータ追加
- ファンクショナルパスのパラメータ名整理
  - clearUAV/RTV…"clearTarget"→"target", "clearValue"→"value"
  - mipmapgen…"mipTarget"→"target"
  - copy…"copySrc"→"src", "copyDest"→"dest"
- ポストプロセスからmatDescを使えるようにした
- 2D/3Dテクスチャtypeのデフォルト値はformatから推定するようにした。bufferはfloat4で変わらず
- マテリアルで参照されている共有元のシェーダを更新すると共有が切れる、共有元自体も共有リソースにアクセスできなくなるのを修正
- rasterizerパスでrasterModelTarget==Bufferの場合、layoutパラメータでinputElementDescを指定できるようにした
- FXInputElementDesc.alignedByteOffsetのデフォルト値をD3D12_APPEND_ALIGNED_ELEMENTにした
- computeパス用にFXPass::numthreadsパラメータ追加。ceil(outputSize/numthreads)でスレッドグループ数を決定する
- ↑に伴い、computeパスをコンパイル時YRZ_NUMTHREADSマクロが定義されるようにした。numthreads(...)に展開される。computeパスのエントリポイントに併記すべし
- ComputeShader専用のコマンドリスト、コマンドキュー、コマンドアロケータを削除し、グラフィックス用と一本化した。これにより、フェンスによる同期の回数が激減し、パフォーマンスが向上した
- #include<>形式のインクルードに対応、<>の場合の検索パスには`MikuMikuDayo/hlsl/`が指定される
- outputSizeのデフォルト値の決定アルゴリズムの変更。
  1. RTVにリソースが指定されていれば最初のリソースのサイズ
  1. DSVにリソースが指定されていればそのリソースのサイズ
  1. UAVにリソースが指定されていれば最初のリソースのサイズ
  1. どれも指定されていなければ従来のアルゴリズムで決定
  1. (従来のアルゴリズム…デフォーマの場合は頂点数、それ以外の場合は出力画面の解像度)

### PMXLoader
- IKの挙動を本家に近づけた
- 多段付与が正しく行われていなかったのを修正
- ANSIエンコード時に16バイト以上のボーン・モーフ名を含むvmdファイルを扱えるようになった

### エフェクト
- DoF、畳み込み時にCoCで重みづけをするようにした(sdPBRのDoFに近い見た目になる)
- subayai,bdptにRoughnessUVパラメータなどUV座標をどこから持ってくるかの指定のためのパラメータ群追加
- subayai, IridescenceLoopsが無効だったのを修正
- コントローラのモーフ選択コンボボックス上にマウスカーソルを合わせると説明が表示されるようになった
- flow、出力fpsが大きい時などで1フレーム当たりの生成数が1未満になる場合、全くパーティクルが生成されなくなるバグを修正 
- flow、床にひっついた状態になったパーティクルがいつまでも微妙に動いたり乱流の影響でウロウロするのを修正

## β3→β4

### MikuMikuDayo.exe
- モデル編集中もカメラキーを表示するオプションの追加
- 選択中の材質がハイライトされるようにした
- shift+Tabでモデル逆送り
- キーフレームウィンドウを再生中に消えないようにした(操作は出来ない状態になる)
- ポストプロセスの起動元モデルはBLASを維持・更新せず、デフォーマの対象外となるようにし、起動元モデルは基本的に表示されないようになった
- `samples`>1の出力時にポストプロセスは出力直前のフレームに対してのみ実行されるようになった
- エフェクトから取得できる時刻についての情報(realTime, dRealTime, frameTime, dFrameTime)を以下のようなポリシーに基づいて変更した
  - 以前はこれらはレンダラを基準に設定されているに過ぎなかった
  - マルチサンプルを考慮する
  - ポストプロセスは出力時は最後のフレームにしか実行されないので出力時のdRealTime,dFrameTimeは変える必要がある
  - デフォーマはupdateReqがtrueの時にしか起動されないのがその事は考えられていない→dRealTime,dFrameTimeを変える必要あり
  - 解決策 … realTime,frameTimeだけレンダラに渡して、後はレンダラ内で管理するようにした
- PMXモデル読み込み時に剛体への参照が切れているジョイントがあるとクラッシュする事を修正
- 読み飛ばされたモデルが複数ある場合に以下の不具合がある事を修正
  - `order`の更新がうまくされておらずクラッシュする事があった
  - 読み飛ばされたモデルに対するキーフレームの読み飛ばしが行われていなかった
- モーフやボーンをいじると表示上物理がリセットされた状態になってしまう事を一部修正
- dayoロード時にレンダラのコンパイルに失敗した場合、レンダラのソースを修正してもmatDescが空のまま→何かモデルを削除するとクラッシュするのを修正、というかdayo読み込み時にレンダラがクラッシュした場合は明らかに異常な動作なので再起動を促すようにした
- 音声データ読み込み時にそれまでのボリューム設定がウィンドウ上でしか反映されていなかった点を修正
- 名前のないモデルより後のモデルが外部親候補に出ないのを修正
- `order`ダイアログのソートの挙動を入れ替えではなく挿入にした
- dayoファイル読み込み時にポストプロセス付きモデルを読み込み中にエフェクトのコンパイルエラーが起きるとポストプロセスのついてないモデルにポストプロセスが付いているとしてorder上でズレるため、ポストプロセスの実行順リスト上にポストプロセスの付いていないモデルも混在させるようにした

### ツール類
- henDayo追加 .dayoファイルのjson部分を編集するためのもの

### エフェクト
- エフェクトの拡張子を.fxdayoにした(.fxだと本家MMD用のエフェクトを読み込もうとしてしまうので)
- Subayai追加
- 各種ポストプロセスとパーティクルサンプル追加
- BDPTのフォルダ構成変更。マテリアル置き場が `renderer/m/` → `renderer/BDPT/m/`になった
- 材質毎のスイッチを付けたい 表示・非表示とか → マテリアルでα値を設定できるようにし、レンダラの実装依存にした
- BDPTのマテリアル、Roughnessはfloat2→floatに変更、Anisotropyパラメータの追加

### よろずFX
- FXController::slider追加。エフェクトコントローラのモーフスライダーの最大・最小値などの設定ができるようになった
- outputSizeのデフォルト値の計算法を変更。パスのRTV[0]、DSV、UAV[0]に何かリソースがあればその順に出力サイズの基準とする。何もない場合にdefaultOutputSizeを参照する
- outputSize.baseに"DEFAULT_RTSIZE"を指定するとUAVやRTVに何か指定されていた場合にも出力先のサイズの基準を画面のサイズに出来るようにした
- 式処理モジュールExpr.ixx追加。材質注釈とpass.conditionsの処理に用いるようにした
- ラスタライザパスでrasterVBを省略した場合、VertexBufferなしで描画するようにした(パーティクルなどSV_Indexのみでvertex shaderが完結する場合の用途
- デフォーマでスクリーンスペースの情報を得る場合にラスタライザを利用する時に困る問題(resources.hlsli参照)→デフォーマのModelIndex→DeformIndex,DeformIndex→DeformOrder, RasterizeIndex→RasterizeOrderに変更
- モデルの増減に伴ってCreatePassをするとPassオブジェクトが再作成されてしまうので非常に遅い  
なんとかUpdateでいけんか→RootSignature上で変化が無ければUpdateは極めて速いという事に気づいたのでダミーリソースで埋めて、少々のモデルの増減ならRootSignatureに変化が無いようにして高速化できた
- ポストプロセス、デフォーマからラスタライザを起動できるようになった
- エフェクト内で定義されるVB,IBを元にラスタライザパスを起動できるようになった
- ポストプロセス、デフォーマのラスタライザパスにrenderModelTarget属性の追加。自身に割り当てられたモデルのみ/それ以外/全てのモデルをラスタライザの対象として選択できる
- パスのoutputSizeにbaseに何を指定されていようと常にsrcが「画面サイズ」になってしまう事と、デフォーマではあらゆるパスでoutputSizeが画面サイズに連動して変更できない事を修正
- sizedependentなBufferがあった場合、リサイズするとクラッシュする事を修正
- clearRTV,clearUAVでrtv,uav非対応のテクスチャを指定するとチェックされずにクラッシュするのを修正
- passのUAV,RTV,DSVに指定されたテクスチャがちゃんと存在するのかチェックするようにした


### よろずDXR

- pass::RenderでRTVをクリアする際に、RTV[0]しかクリアされていなかったのを修正


## β2→β3

### MikuMikuDayo.exe
- 背景動画読み込み機能の追加。mp4またはaviファイルをドロップするとscreen.bmpに動画のフレームを読み込む
- αチャンネル付き出力の追加。screenshotを透過に対応できるようpng形式にした
- 背景モードの追加(screen.bmp/単色/チェッカー)
- 「背景をα=0として出力する」スイッチを付けた
- テンキーの0で「カメラをキーフレームの状態に合わせる」事にした
- ↑に伴い、テンキーの1に背面カメラは移された
- モデル編集時照明・カメラ追従メニュー追加
- renderer窓右下にXYZ操作を追加
- 表示枠(node)に入ってないモーフはモーフ操作ウィンドウに出ないようにした
- 「動作モード」の導入
- VMDファイルのエクスポート
- 再生時にフリーカメラモード、再生しながらカメラの記録
- IJKLとかカメラ記録みたいに1つの動作にコマンドを2つ以上パックしてる場合、巻き戻しにCtrl+Zが2回以上必要だったので、undoBufferにpackメンバの追加。何個のコマンドを一度にアンドゥ- リドゥするか記録できるようし、まとめてundo、redoするようにした。
- Animtaion窓のスライダーの範囲を「最後にキーフレームが打たれているフレーム」から「最後にキーフレームが打たれているフレームまたはアニメーション再生範囲終了のうち後の方」にした
- 物理演算の内部fps, 再生/録画前のステップ数の指定をできるようにした
- 30fps以外の動画の作成
- 剛体表示の追加、剛体が〇ではなく、球・カプセル・箱型に沿うようにした
　編集中モデルだけでなく全モデルについて行うようにし、録画時以外は常に表示されるようにした
- カメラモードでallだけでなくカメラだけ、照明だけキー選択の追加
- エフェクトからマウスカーソルの位置やボタンのクリック状態の取得
- PMX2.1モデルの読み込みに対応、以下のPMX2.1新仕様に対応
  - 5種類の追加ジョイント
  - デュアルクォータニオンスキニング
  - フリップモーフ・インパルスモーフ
- 未対応のPMX2.1仕様はsoftbodyとline,point描画
- エフェクトデバッグ補助。エフェクトを選択して定義されているバッファの中身などを見れるようにする
- モデルのモーション計算順(外部親解決用)
- モデルの表示順(ラスタライザ用)
- ポストプロセス表示順
- デフォーマ計算順
- AddModel(LoadDayo)で不正なPMXモデルが指定された場合は読み飛ばすようにした

### よろずDXR
主な点のみ記載。詳細はYRZ.ixx参照。
- 3Dテクスチャをサポート。YRZ::Tex3D型の追加

### よろずFX
- controllersに指定する変数の配列化ができるようになった。同名のpmxがMMDayo内にある場合、各々からモーフ値などを取得可能に
- controllersにint型を追加。モデルID・ボーン・モーフの番号の取得
- MatDesc内で式・マクロ・組み込み関数の呼び出しができるようになった
- MatDescでコントローラ・CBからの値を得られるようにした
- MatDescのテクスチャにエフェクト内で定義されるリソース、または共有リソースを指定できるようにした
- 未来のバージョンのファイルが指定された場合、エラーメッセージを出すようにした
　(β2ではバージョンチェックを行わずに落ちるだけなので注意)

### BDPT.fx
- AutoLuminous材質からemissionへの変換(点滅モーフなどには非対応)
- BDPT.fx、ボリュームレンダリングに対応
- BDPT スフィアマップのon/off(EnableSphereMapの追加)など、マテリアルパラメータ追加。詳細はrenderer/m/_template.txtを参照
- OpenVDB形式のファイルをDDSファイルに変換して扱えるようにするツール、VDB2DDS.exe追加

### バグ修正
- dayoファイルがMikuMikuDayoの作業フォルダ以外に置いてあるとレンダラの読み込みに失敗するのを修正
- ボーンの姿勢の直接入力時にY=90度を超えると数値がガタガタ動いていたのでBone窓のrotation入力欄の挙動を改良
- BDPT.fxの表面下散乱に一部誤りがあったのを訂正(更新後のe.PがTraceRayの原点になってなかった)
- dayoファイルから参照されているモデルからマテリアルが削減されている場合、ロード時に落ちる事があるのを修正
- dayoファイルから参照されているモデルが削除されている場合、ロード時に落ちる事があるのを修正
- dayoファイルの読み込みだけでは床有効のUIだけが更新されて実際には床有効が反映されていないのを修正
- 光源ポリゴンのサンプリングに以下の誤りを見つけたので訂正
  - BDPT.fxのSampleFirstLight()でXiの使いまわし方を誤って重複するXiの要素を違うサンプリングに用いていた
  - system/modelLight.hlslでVBの型がVertexExではなくVertexのままになっていた
- 「両端の剛体が同じボーンに関連づいている」ジョイントは生成されないバグがあったので
- 「両端が同じ剛体に繋がっている」ジョイントは生成しないとして条件を正しくした
- 光源・セルフシャドウの登録ボタンが常にdisabled状態になっていたのを修正



## β2
- 複数モデルの取り扱い開始
- ImGUIによるキーフレームの編集用UIが付いた
- エフェクトフレームワーク、よろずFXの開発開始
- OneClickMovie.exe追加


## β1
- 初公開
- DirectX Raytracingフレームワーク、よろずDXR開発開始
- 1体のモデルの表示のみに対応したSimple/PT/BDPTレンダラがあった
- Intel OIDNによるデノイズ
- vmdファイルの読み込みとBulletPhysicsによる物理演算に対応していた
